<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>背景音</title>
    <link rel="stylesheet" href="https://unpkg.com/mdui@2/mdui.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200">
    <script src="https://unpkg.com/mdui@2/mdui.global.js"></script>
    <style>
        :root {
            --md-sys-color-primary: #a8c7fa;
            --md-sys-color-on-primary: #062e6f;
            --md-sys-color-primary-container: #284777;
            --md-sys-color-on-primary-container: #d3e3fd;
            --md-sys-color-surface: #131316;
            --md-sys-color-on-surface: #e3e2e6;
            --md-sys-color-surface-variant: #44464f;
            --md-sys-color-on-surface-variant: #c4c6d0;
            --md-sys-color-outline: #8e9099;
            --md-sys-color-outline-variant: #44464f;
            --md-sys-color-inverse-surface: #e3e2e6;
            --md-sys-color-inverse-on-surface: #131316;
            --md-sys-color-secondary-container: rgba(255, 255, 255, 0.12);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: 'Roboto', system-ui, sans-serif;
            background: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
            transition: background-color 0.6s ease;
        }

        .material-symbols-rounded {
            font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }

        /* 背景层 */
        .bg-layer {
            position: fixed;
            inset: 0;
            background-size: cover;
            background-position: center;
            opacity: 0;
            transition: opacity 1s ease;
            z-index: 0;
        }

        .bg-layer.active {
            opacity: 1;
        }

        .bg-overlay {
            position: fixed;
            inset: 0;
            background: linear-gradient(
                to bottom,
                rgba(0, 0, 0, 0.35) 0%,
                rgba(0, 0, 0, 0.55) 100%
            );
            z-index: 1;
        }

        /* 主容器 */
        .main-container {
            position: relative;
            z-index: 10;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }

        /* 当前播放 */
        .now-playing {
            text-align: center;
            margin-bottom: 48px;
            opacity: 0;
            transform: translateY(20px);
            animation: fadeUp 0.6s ease 0.1s forwards;
        }

        .now-playing-label {
            font-size: 0.75rem;
            font-weight: 500;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: var(--md-sys-color-on-surface-variant);
            margin-bottom: 12px;
        }

        .now-playing-title {
            font-size: 2.25rem;
            font-weight: 300;
            letter-spacing: 1px;
            color: var(--md-sys-color-on-surface);
            text-shadow: 0 2px 12px rgba(0, 0, 0, 0.3);
        }

        @keyframes fadeUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* 播放按钮 */
        .play-fab {
            --md-fab-container-color: var(--md-sys-color-secondary-container);
            --md-fab-icon-color: var(--md-sys-color-on-surface);
            width: 96px;
            height: 96px;
            margin-bottom: 56px;
            opacity: 0;
            transform: scale(0.8);
            animation: scaleIn 0.5s ease 0.2s forwards;
            position: relative;
        }

        .play-fab::part(button) {
            width: 96px;
            height: 96px;
            border-radius: 50%;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }

        .play-fab .material-symbols-rounded {
            font-size: 42px;
        }

        .play-fab.playing::before {
            content: '';
            position: absolute;
            inset: -6px;
            border-radius: 50%;
            border: 2px solid var(--md-sys-color-primary);
            opacity: 0.6;
            animation: ripple 2s ease-out infinite;
        }

        @keyframes scaleIn {
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes ripple {
            0% { transform: scale(1); opacity: 0.6; }
            100% { transform: scale(1.35); opacity: 0; }
        }

        /* 音乐选择器 */
        .selector-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: center;
            max-width: 360px;
            opacity: 0;
            animation: fadeUp 0.6s ease 0.3s forwards;
        }

        .selector-chip {
            --md-filled-tonal-button-container-color: var(--md-sys-color-secondary-container);
            --md-filled-tonal-button-label-text-color: var(--md-sys-color-on-surface-variant);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            min-width: 56px;
        }

        .selector-chip[selected] {
            --md-filled-tonal-button-container-color: var(--md-sys-color-primary-container);
            --md-filled-tonal-button-label-text-color: var(--md-sys-color-on-primary-container);
        }

        .selector-chip::part(button) {
            border-radius: 16px;
            padding: 0 16px;
            height: 40px;
        }

        .selector-chip mdui-circular-progress {
            --mdui-color-primary: var(--md-sys-color-on-surface);
            width: 18px;
            height: 18px;
        }

        /* 底部控制栏 */
        .bottom-controls {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 100;
            padding: 16px 20px;
            padding-bottom: max(16px, env(safe-area-inset-bottom));
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            pointer-events: none;
        }

        .control-card {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border-radius: 28px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            display: flex;
            align-items: center;
            padding: 4px;
            pointer-events: auto;
            opacity: 0;
            animation: fadeUp 0.6s ease 0.4s forwards;
            transition: all 0.35s cubic-bezier(0.2, 0, 0, 1);
            overflow: hidden;
        }

        .control-card mdui-button-icon {
            --md-icon-button-icon-color: var(--md-sys-color-on-surface-variant);
            flex-shrink: 0;
        }

        .control-card mdui-button-icon:hover {
            --md-icon-button-icon-color: var(--md-sys-color-on-surface);
        }

        .control-card mdui-button-icon.active {
            --md-icon-button-icon-color: var(--md-sys-color-primary);
        }

        /* 音量控制 */
        .volume-card {
            width: 48px;
        }

        .volume-card.expanded {
            width: 180px;
        }

        .volume-slider-wrap {
            width: 0;
            opacity: 0;
            overflow: hidden;
            transition: all 0.35s cubic-bezier(0.2, 0, 0, 1);
            display: flex;
            align-items: center;
            padding-right: 0;
        }

        .volume-card.expanded .volume-slider-wrap {
            width: 120px;
            opacity: 1;
            padding-right: 12px;
        }

        .volume-slider-wrap mdui-slider {
            --md-slider-active-track-color: var(--md-sys-color-primary);
            --md-slider-inactive-track-color: var(--md-sys-color-outline-variant);
            --md-slider-handle-color: var(--md-sys-color-primary);
            width: 100%;
        }

        /* 定时器控制 */
        .timer-card {
            width: 48px;
            flex-direction: row-reverse;
        }

        .timer-card.expanded {
            width: 220px;
        }

        .timer-options {
            width: 0;
            opacity: 0;
            overflow: hidden;
            transition: all 0.35s cubic-bezier(0.2, 0, 0, 1);
            display: flex;
            align-items: center;
            gap: 4px;
            padding-left: 0;
        }

        .timer-card.expanded .timer-options {
            width: 160px;
            opacity: 1;
            padding-left: 4px;
        }

        .timer-opt {
            --md-text-button-label-text-color: var(--md-sys-color-on-surface-variant);
            min-width: 36px;
        }

        .timer-opt::part(button) {
            padding: 0 8px;
            height: 32px;
            border-radius: 12px;
        }

        .timer-opt[selected] {
            --md-text-button-label-text-color: var(--md-sys-color-primary);
            background: var(--md-sys-color-secondary-container);
            border-radius: 12px;
        }

        /* 倒计时 */
        .countdown-display {
            position: fixed;
            bottom: 80px;
            left: 20px;
            padding-bottom: env(safe-area-inset-bottom);
            z-index: 99;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s ease;
            pointer-events: none;
        }

        .countdown-display.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .countdown-display mdui-chip {
            --md-assist-chip-container-color: rgba(0, 0, 0, 0.4);
            --md-assist-chip-label-text-color: var(--md-sys-color-on-surface-variant);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
        }

        /* 响应式 */
        @media (max-width: 480px) {
            .now-playing-title {
                font-size: 1.75rem;
            }

            .play-fab {
                width: 80px;
                height: 80px;
            }

            .play-fab::part(button) {
                width: 80px;
                height: 80px;
            }

            .play-fab .material-symbols-rounded {
                font-size: 36px;
            }

            .selector-chip::part(button) {
                height: 36px;
                padding: 0 14px;
            }

            .bottom-controls {
                padding: 12px 16px;
            }
        }
    </style>
</head>
<body>
    <div id="bgContainer"></div>
    <div class="bg-overlay"></div>

    <div class="main-container">
        <div class="now-playing">
            <div class="now-playing-label">Now Playing</div>
            <div class="now-playing-title" id="currentTitle">Ocean</div>
        </div>

        <mdui-fab class="play-fab" id="playBtn">
            <mdui-icon slot="icon" class="material-symbols-rounded" id="playIcon">play_arrow</mdui-icon>
        </mdui-fab>

        <div class="selector-group" id="selectorGroup"></div>
    </div>

    <!-- 倒计时显示 -->
    <div class="countdown-display" id="countdownDisplay">
        <mdui-chip elevated>
            <mdui-icon slot="icon" class="material-symbols-rounded">timer</mdui-icon>
            <span id="countdownText">0:00</span>
        </mdui-chip>
    </div>

    <!-- 底部控制栏 -->
    <div class="bottom-controls">
        <!-- ���时器 -->
        <div class="control-card timer-card" id="timerCard">
            <mdui-button-icon id="timerBtn">
                <mdui-icon class="material-symbols-rounded">schedule</mdui-icon>
            </mdui-button-icon>
            <div class="timer-options">
                <mdui-button variant="text" class="timer-opt" data-time="15">15m</mdui-button>
                <mdui-button variant="text" class="timer-opt" data-time="30">30m</mdui-button>
                <mdui-button variant="text" class="timer-opt" data-time="60">1h</mdui-button>
                <mdui-button variant="text" class="timer-opt" data-time="0">
                    <mdui-icon class="material-symbols-rounded">close</mdui-icon>
                </mdui-button>
            </div>
        </div>

        <!-- 音量 -->
        <div class="control-card volume-card" id="volumeCard">
            <mdui-button-icon id="volBtn">
                <mdui-icon class="material-symbols-rounded">volume_up</mdui-icon>
            </mdui-button-icon>
            <div class="volume-slider-wrap">
                <mdui-slider id="volSlider" min="0" max="100" value="80"></mdui-slider>
            </div>
        </div>
    </div>

    <!-- 隐藏的 canvas 用于提取颜色 -->
    <canvas id="colorCanvas" width="1" height="1" style="display:none;"></canvas>

    <script>
        const musicData = [
            { name: 'Ocean', file: 'Ocean.m4a', img: 'Ocean.jpg', abbr: 'OCN' },
            { name: 'Brown Noise', file: 'BrownNoise.m4a', img: 'BrownNoise.jpg', abbr: 'BRN' },
            { name: 'Pink Noise', file: 'PinkNoise.m4a', img: 'PinkNoise.jpg', abbr: 'PNK' },
            { name: 'Rain', file: 'Rain.m4a', img: 'Rain.jpg', abbr: 'RAN' },
            { name: 'Stream', file: 'Stream.m4a', img: 'Stream.jpg', abbr: 'STM' },
            { name: 'White Noise', file: 'WhiteNoise.m4a', img: 'WhiteNoise.jpg', abbr: 'WHT' }
        ];

        // DOM 元素
        const bgContainer = document.getElementById('bgContainer');
        const selectorGroup = document.getElementById('selectorGroup');
        const playBtn = document.getElementById('playBtn');
        const playIcon = document.getElementById('playIcon');
        const currentTitle = document.getElementById('currentTitle');
        const volSlider = document.getElementById('volSlider');
        const volumeCard = document.getElementById('volumeCard');
        const volBtn = document.getElementById('volBtn');
        const timerCard = document.getElementById('timerCard');
        const timerBtn = document.getElementById('timerBtn');
        const countdownDisplay = document.getElementById('countdownDisplay');
        const countdownText = document.getElementById('countdownText');
        const colorCanvas = document.getElementById('colorCanvas');
        const colorCtx = colorCanvas.getContext('2d', { willReadFrequently: true });

        // Web Audio API
        let audioContext = null;
        let gainNode = null;
        let currentSource = null;
        const audioBufferCache = {};

        let currentIndex = 0;
        let isPlaying = false;
        let isLoading = false;

        // 定时器
        let timerInterval = null;
        let remainingSeconds = 0;

        // 颜色缓存
        const colorCache = {};

        // 预创建背景图层
        musicData.forEach((item, index) => {
            const layer = document.createElement('div');
            layer.className = 'bg-layer';
            layer.style.backgroundImage = `url('img/${item.img}')`;
            if (index === 0) layer.classList.add('active');
            bgContainer.appendChild(layer);

            // 预加载图片并提取颜色
            const img = new Image();
            img.crossOrigin = 'anonymous';
            img.onload = () => {
                colorCache[index] = extractColors(img);
                if (index === 0) applyColors(colorCache[0]);
            };
            img.src = `img/${item.img}`;
        });

        // 创建选择器
        musicData.forEach((item, index) => {
            const chip = document.createElement('mdui-button');
            chip.className = 'selector-chip';
            chip.setAttribute('variant', 'tonal');
            chip.innerHTML = `<span class="chip-label">${item.abbr}</span>`;
            if (index === 0) chip.setAttribute('selected', '');
            chip.onclick = () => selectMusic(index);
            selectorGroup.appendChild(chip);
        });

        // 提取图片主色调
        function extractColors(img) {
            const size = 50;
            colorCanvas.width = size;
            colorCanvas.height = size;
            colorCtx.drawImage(img, 0, 0, size, size);

            const imageData = colorCtx.getImageData(0, 0, size, size).data;
            const colors = [];

            for (let i = 0; i < imageData.length; i += 4) {
                const r = imageData[i];
                const g = imageData[i + 1];
                const b = imageData[i + 2];
                const hsl = rgbToHsl(r, g, b);
                // 过滤太暗或太亮的颜色
                if (hsl.l > 0.15 && hsl.l < 0.85 && hsl.s > 0.2) {
                    colors.push({ r, g, b, h: hsl.h, s: hsl.s, l: hsl.l });
                }
            }

            // 按色相分组并找主色
            if (colors.length === 0) {
                return { primary: { r: 168, g: 199, b: 250 } }; // 默认蓝色
            }

            // 简单平均获取主色
            const avg = colors.reduce((acc, c) => {
                acc.r += c.r;
                acc.g += c.g;
                acc.b += c.b;
                return acc;
            }, { r: 0, g: 0, b: 0 });

            avg.r = Math.round(avg.r / colors.length);
            avg.g = Math.round(avg.g / colors.length);
            avg.b = Math.round(avg.b / colors.length);

            return { primary: avg };
        }

        function rgbToHsl(r, g, b) {
            r /= 255; g /= 255; b /= 255;
            const max = Math.max(r, g, b), min = Math.min(r, g, b);
            let h, s, l = (max + min) / 2;

            if (max === min) {
                h = s = 0;
            } else {
                const d = max - min;
                s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                switch (max) {
                    case r: h = ((g - b) / d + (g < b ? 6 : 0)) / 6; break;
                    case g: h = ((b - r) / d + 2) / 6; break;
                    case b: h = ((r - g) / d + 4) / 6; break;
                }
            }
            return { h, s, l };
        }

        function hslToRgb(h, s, l) {
            let r, g, b;
            if (s === 0) {
                r = g = b = l;
            } else {
                const hue2rgb = (p, q, t) => {
                    if (t < 0) t += 1;
                    if (t > 1) t -= 1;
                    if (t < 1/6) return p + (q - p) * 6 * t;
                    if (t < 1/2) return q;
                    if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
                    return p;
                };
                const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
                const p = 2 * l - q;
                r = hue2rgb(p, q, h + 1/3);
                g = hue2rgb(p, q, h);
                b = hue2rgb(p, q, h - 1/3);
            }
            return { r: Math.round(r * 255), g: Math.round(g * 255), b: Math.round(b * 255) };
        }

        function applyColors(colors) {
            if (!colors) return;

            const { r, g, b } = colors.primary;
            const hsl = rgbToHsl(r, g, b);

            // 生成 Material Design 3 调色板
            const primary = hslToRgb(hsl.h, Math.min(hsl.s * 1.2, 0.9), 0.75);
            const onPrimary = hslToRgb(hsl.h, hsl.s, 0.15);
            const primaryContainer = hslToRgb(hsl.h, Math.min(hsl.s * 0.8, 0.7), 0.35);
            const onPrimaryContainer = hslToRgb(hsl.h, Math.min(hsl.s * 0.6, 0.5), 0.88);

            const root = document.documentElement;
            root.style.setProperty('--md-sys-color-primary', `rgb(${primary.r}, ${primary.g}, ${primary.b})`);
            root.style.setProperty('--md-sys-color-on-primary', `rgb(${onPrimary.r}, ${onPrimary.g}, ${onPrimary.b})`);
            root.style.setProperty('--md-sys-color-primary-container', `rgb(${primaryContainer.r}, ${primaryContainer.g}, ${primaryContainer.b})`);
            root.style.setProperty('--md-sys-color-on-primary-container', `rgb(${onPrimaryContainer.r}, ${onPrimaryContainer.g}, ${onPrimaryContainer.b})`);
        }

        function initAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                gainNode = audioContext.createGain();
                gainNode.gain.value = volSlider.value / 100;
                gainNode.connect(audioContext.destination);
            }
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
        }

        async function loadAudioBuffer(url) {
            if (audioBufferCache[url]) return audioBufferCache[url];
            const response = await fetch(url);
            const arrayBuffer = await response.arrayBuffer();
            const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
            audioBufferCache[url] = audioBuffer;
            return audioBuffer;
        }

        function playWithWebAudio(buffer) {
            stopCurrentSource();
            const source = audioContext.createBufferSource();
            source.buffer = buffer;
            source.loop = true;
            source.connect(gainNode);
            source.start(0);
            currentSource = source;
        }

        function stopCurrentSource() {
            if (currentSource) {
                try { currentSource.stop(); } catch (e) {}
                currentSource.disconnect();
                currentSource = null;
            }
        }

        async function selectMusic(index) {
            if (currentIndex === index || isLoading) return;

            initAudioContext();

            const chips = selectorGroup.querySelectorAll('.selector-chip');
            const bgLayers = bgContainer.querySelectorAll('.bg-layer');

            chips[currentIndex].removeAttribute('selected');
            bgLayers[currentIndex].classList.remove('active');

            chips[index].setAttribute('selected', '');
            bgLayers[index].classList.add('active');

            currentIndex = index;
            currentTitle.textContent = musicData[index].name;

            // 应用新的配色
            if (colorCache[index]) {
                applyColors(colorCache[index]);
            }

            if (isPlaying) {
                isLoading = true;
                chips[index].innerHTML = '<mdui-circular-progress></mdui-circular-progress>';

                try {
                    const buffer = await loadAudioBuffer(`music/${musicData[index].file}`);
                    playWithWebAudio(buffer);
                } catch (e) {
                    console.error('加载失败:', e);
                } finally {
                    isLoading = false;
                    chips[index].innerHTML = `<span class="chip-label">${musicData[index].abbr}</span>`;
                }
            }
        }

        async function togglePlay() {
            initAudioContext();

            const chips = selectorGroup.querySelectorAll('.selector-chip');

            if (isPlaying) {
                stopCurrentSource();
                playBtn.classList.remove('playing');
                playIcon.textContent = 'play_arrow';
                isPlaying = false;
            } else {
                isLoading = true;
                chips[currentIndex].innerHTML = '<mdui-circular-progress></mdui-circular-progress>';

                try {
                    const buffer = await loadAudioBuffer(`music/${musicData[currentIndex].file}`);
                    playWithWebAudio(buffer);
                    playBtn.classList.add('playing');
                    playIcon.textContent = 'pause';
                    isPlaying = true;
                } catch (e) {
                    console.error('加载失败:', e);
                } finally {
                    isLoading = false;
                    chips[currentIndex].innerHTML = `<span class="chip-label">${musicData[currentIndex].abbr}</span>`;
                }
            }
        }

        playBtn.onclick = togglePlay;

        // 音量控制
        volBtn.onclick = (e) => {
            e.stopPropagation();
            volumeCard.classList.toggle('expanded');
            timerCard.classList.remove('expanded');
        };

        volSlider.addEventListener('input', (e) => {
            if (gainNode) {
                gainNode.gain.value = e.target.value / 100;
            }
        });

        // 定时器控制
        timerBtn.onclick = (e) => {
            e.stopPropagation();
            timerCard.classList.toggle('expanded');
            volumeCard.classList.remove('expanded');
        };

        document.querySelectorAll('.timer-opt').forEach(btn => {
            btn.onclick = (e) => {
                e.stopPropagation();
                const minutes = parseInt(btn.dataset.time);

                document.querySelectorAll('.timer-opt').forEach(b => b.removeAttribute('selected'));

                if (minutes === 0) {
                    clearTimer();
                    timerBtn.classList.remove('active');
                } else {
                    btn.setAttribute('selected', '');
                    timerBtn.classList.add('active');
                    startTimer(minutes);
                }

                setTimeout(() => {
                    timerCard.classList.remove('expanded');
                }, 200);
            };
        });

        function startTimer(minutes) {
            clearTimer();
            remainingSeconds = minutes * 60;
            updateCountdown();
            countdownDisplay.classList.add('visible');
            timerBtn.classList.add('active');

            timerInterval = setInterval(() => {
                remainingSeconds--;
                if (remainingSeconds <= 0) {
                    clearTimer();
                    timerBtn.classList.remove('active');
                    if (isPlaying) {
                        togglePlay();
                    }
                } else {
                    updateCountdown();
                }
            }, 1000);
        }

        function clearTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            remainingSeconds = 0;
            countdownDisplay.classList.remove('visible');
            document.querySelectorAll('.timer-opt').forEach(b => b.removeAttribute('selected'));
        }

        function updateCountdown() {
            const mins = Math.floor(remainingSeconds / 60);
            const secs = remainingSeconds % 60;
            countdownText.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // 点击其他区域关闭
        document.addEventListener('click', (e) => {
            if (!volumeCard.contains(e.target)) {
                volumeCard.classList.remove('expanded');
            }
            if (!timerCard.contains(e.target)) {
                timerCard.classList.remove('expanded');
            }
        });
    </script>
</body>
</html>

